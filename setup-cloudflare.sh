#!/bin/bash

# –°–∫—Ä–∏–ø—Ç —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏ –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ Cloudflare –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Let's Encrypt
# –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É (—Ç—Ä–µ–±—É–µ—Ç—Å—è —Ä—É—á–Ω–æ–µ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–æ),
# –Ω–æ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ç–æ—á–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏

echo "‚òÅÔ∏è  –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Cloudflare –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Let's Encrypt"
echo "=================================================="

# –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ IP —Å–µ—Ä–≤–µ—Ä–∞
SERVER_IP=$(curl -s ifconfig.me)
DOMAIN="hawklets.com"

echo "üìä –¢–µ–∫—É—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:"
echo "   –î–æ–º–µ–Ω: $DOMAIN"
echo "   –°–µ—Ä–≤–µ—Ä IP: $SERVER_IP"
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ DNS
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–∏—Ö DNS –∑–∞–ø–∏—Å–µ–π:"
echo "--------------------------------"
echo "   –ó–∞–ø–∏—Å—å A –¥–ª—è $DOMAIN:"
dig +short $DOMAIN
echo ""
echo "   –ó–∞–ø–∏—Å—å A –¥–ª—è www.$DOMAIN:"
dig +short www.$DOMAIN
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
echo "üîê –ü—Ä–æ–≤–µ—Ä–∫–∞ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:"
echo "--------------------------------------"
if [ -f "/etc/letsencrypt/live/$DOMAIN/fullchain.pem" ]; then
    echo "‚úÖ Let's Encrypt —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    echo "   –ü—É—Ç—å: /etc/letsencrypt/live/$DOMAIN/"
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞—Ç—ã –∏—Å—Ç–µ—á–µ–Ω–∏—è
    EXPIRY_DATE=$(openssl x509 -in "/etc/letsencrypt/live/$DOMAIN/fullchain.pem" -noout -enddate 2>/dev/null | cut -d= -f2)
    if [ ! -z "$EXPIRY_DATE" ]; then
        echo "   –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è: $EXPIRY_DATE"
    fi
else
    echo "‚ùå Let's Encrypt —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –ù–ï –Ω–∞–π–¥–µ–Ω"
    echo "   –°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —É—Å—Ç–∞–Ω–æ–≤–∫—É Let's Encrypt"
fi
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã SSL –ª–æ–∫–∞–ª—å–Ω–æ
echo "üåê –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã SSL –ª–æ–∫–∞–ª—å–Ω–æ:"
echo "-------------------------------"
echo "   –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—Ç–∞ 443 –Ω–∞ localhost:"
if timeout 5 curl -s -k https://localhost/api/health > /dev/null; then
    echo "   ‚úÖ SSL —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ"
else
    echo "   ‚ùå SSL –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ"
    echo "   –ü—Ä–æ–≤–µ—Ä—å—Ç–µ: docker-compose -f /root/hawklets/docker-compose.prod.yml logs frontend"
fi
echo ""

echo "üéØ –ò–ù–°–¢–†–£–ö–¶–ò–ò –î–õ–Ø –ù–ê–°–¢–†–û–ô–ö–ò CLOUDFLARE:"
echo "======================================"
echo ""
echo "1. üì± –í–û–ô–î–ò–¢–ï –í CLOUDFLARE DASHBOARD"
echo "   URL: https://dash.cloudflare.com"
echo "   –í—ã–±–µ—Ä–∏—Ç–µ –¥–æ–º–µ–Ω: $DOMAIN"
echo ""
echo "2. üåê –û–ë–ù–û–í–ò–¢–ï DNS –ó–ê–ü–ò–°–ò"
echo "   –ü–µ—Ä–µ–π–¥–∏—Ç–µ: DNS ‚Üí Records"
echo "   –ù–∞–π–¥–∏—Ç–µ –∑–∞–ø–∏—Å—å –¥–ª—è $DOMAIN (—Ç–∏–ø A)"
echo "   –ù–∞–∂–º–∏—Ç–µ 'Edit' (–∫–∞—Ä–∞–Ω–¥–∞—à)"
echo "   –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ:"
echo "   - Content/Value: $SERVER_IP"
echo "   - Proxy status: Proxied (–æ—Ä–∞–Ω–∂–µ–≤–æ–µ –æ–±–ª–∞–∫–æ)"
echo "   - TTL: Auto"
echo "   –ù–∞–∂–º–∏—Ç–µ 'Save'"
echo ""
echo "3. üîê –ù–ê–°–¢–†–û–ô–¢–ï SSL/TLS"
echo "   –ü–µ—Ä–µ–π–¥–∏—Ç–µ: SSL/TLS ‚Üí Overview"
echo "   –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ:"
echo "   - SSL/TLS encryption mode: Full (strict)"
echo "   - Always Use HTTPS: On"
echo "   - Minimum TLS Version: TLS 1.2"
echo ""
echo "4. üõ°Ô∏è –ü–†–û–í–ï–†–¨–¢–ï FIREWALL"
echo "   –ü–µ—Ä–µ–π–¥–∏—Ç–µ: Security ‚Üí WAF ‚Üí Custom rules"
echo "   –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –Ω–µ—Ç –ø—Ä–∞–≤–∏–ª –±–ª–æ–∫–∏—Ä—É—é—â–∏—Ö /api/*"
echo "   –ï—Å–ª–∏ –Ω—É–∂–Ω–æ, —Å–æ–∑–¥–∞–π—Ç–µ –ø—Ä–∞–≤–∏–ª–æ:"
echo "   - Rule name: Allow API"
echo "   - Field: URI Path"
echo "   - Operator: contains"
echo "   - Value: /api"
echo "   - Action: Allow"
echo ""
echo "5. ‚ö° –í–ö–õ–Æ–ß–ò–¢–ï –£–°–ö–û–†–ï–ù–ò–ï (–û–ü–¶–ò–û–ù–ê–õ–¨–ù–û)"
echo "   –ü–µ—Ä–µ–π–¥–∏—Ç–µ: Speed ‚Üí Optimization"
echo "   –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:"
echo "   - Auto Minify: –í–∫–ª—é—á–∏—Ç–µ –¥–ª—è JS, CSS, HTML"
echo "   - Brotli: On"
echo ""
echo "6. üìä –í–ö–õ–Æ–ß–ò–¢–ï –ê–ù–ê–õ–ò–¢–ò–ö–£"
echo "   –ü–µ—Ä–µ–π–¥–∏—Ç–µ: Analytics & Logs ‚Üí Web Analytics"
echo "   –î–æ–±–∞–≤—å—Ç–µ —Å–∞–π—Ç –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Ç—Ä–∞—Ñ–∏–∫–∞"
echo ""
echo "‚è±Ô∏è  –í–†–ï–ú–Ø –û–ñ–ò–î–ê–ù–ò–Ø:"
echo "-----------------"
echo "–ü–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π:"
echo "- DNS –∏–∑–º–µ–Ω–µ–Ω–∏—è: 1-5 –º–∏–Ω—É—Ç"
echo "- SSL –∏–∑–º–µ–Ω–µ–Ω–∏—è: 5-15 –º–∏–Ω—É—Ç"
echo "- –ü–æ–ª–Ω–æ–µ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ: –¥–æ 30 –º–∏–Ω—É—Ç"
echo ""
echo "üîç –ü–†–û–í–ï–†–ö–ê –ü–û–°–õ–ï –ù–ê–°–¢–†–û–ô–ö–ò:"
echo "---------------------------"
echo "–í—ã–ø–æ–ª–Ω–∏—Ç–µ —ç—Ç–∏ –∫–æ–º–∞–Ω–¥—ã –ø–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Cloudflare:"
echo ""
echo "# 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ DNS (–¥–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å Cloudflare IP, –Ω–µ –≤–∞—à —Å–µ—Ä–≤–µ—Ä–Ω—ã–π IP)"
echo "dig +short $DOMAIN"
echo ""
echo "# 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ —á–µ—Ä–µ–∑ Cloudflare"
echo "openssl s_client -connect $DOMAIN:443 -servername $DOMAIN < /dev/null 2>/dev/null | openssl x509 -noout -subject -issuer"
echo ""
echo "# 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ API —á–µ—Ä–µ–∑ Cloudflare"
echo "curl -v https://$DOMAIN/api/health"
echo ""
echo "# 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ Cloudflare"
echo "curl -s -I https://$DOMAIN | grep -i 'cf-ray\|server'"
echo ""
echo "‚úÖ –û–ñ–ò–î–ê–ï–ú–´–ï –†–ï–ó–£–õ–¨–¢–ê–¢–´:"
echo "-----------------------"
echo "1. DNS –∑–∞–ø–∏—Å—å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç Cloudflare IP (–Ω–µ $SERVER_IP)"
echo "2. SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç 'Let's Encrypt' –∏–ª–∏ 'Cloudflare'"
echo "3. API –æ—Ç–≤–µ—á–∞–µ—Ç: {\"status\":\"healthy\",...}"
echo "4. –ó–∞–≥–æ–ª–æ–≤–∫–∏ —Å–æ–¥–µ—Ä–∂–∞—Ç 'cloudflare' –∏–ª–∏ 'CF-Ray'"
echo ""
echo "üö® –£–°–¢–†–ê–ù–ï–ù–ò–ï –ù–ï–ü–û–õ–ê–î–û–ö:"
echo "----------------------"
echo ""
echo "–ü—Ä–æ–±–ª–µ–º–∞: ERR_CONNECTION_REFUSED"
echo "–†–µ—à–µ–Ω–∏–µ:"
echo "1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –ø–æ—Ä—Ç 443 –æ—Ç–∫—Ä—ã—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:"
echo "   sudo ufw status"
echo "   sudo ufw allow 443/tcp"
echo ""
echo "2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∑–∞–ø—É—â–µ–Ω—ã:"
echo "   cd /root/hawklets"
echo "   docker-compose -f docker-compose.prod.yml ps"
echo ""
echo "3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ nginx:"
echo "   docker-compose -f docker-compose.prod.yml logs frontend"
echo ""
echo "–ü—Ä–æ–±–ª–µ–º–∞: SSL certificate error"
echo "–†–µ—à–µ–Ω–∏–µ:"
echo "1. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ Cloudflare –≤ —Ä–µ–∂–∏–º–µ 'Full (strict)'"
echo "2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç Let's Encrypt –≤–∞–ª–∏–¥–µ–Ω:"
echo "   sudo certbot certificates"
echo ""
echo "–ü—Ä–æ–±–ª–µ–º–∞: API —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–æ —Å–∞–π—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç"
echo "–†–µ—à–µ–Ω–∏–µ:"
echo "1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ frontend –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω"
echo "2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ nginx –æ–±—Å–ª—É–∂–∏–≤–∞–µ—Ç —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã"
echo ""
echo "üìû –ï–°–õ–ò –ü–†–û–ë–õ–ï–ú–ê –û–°–¢–ê–ï–¢–°–Ø:"
echo "-------------------------"
echo "1. –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç–µ Cloudflare –ø—Ä–æ–∫—Å–∏:"
echo "   - –í DNS –∑–∞–ø–∏—Å–∏ –∏–∑–º–µ–Ω–∏—Ç–µ –Ω–∞ 'DNS only' (—Å–µ—Ä–æ–µ –æ–±–ª–∞–∫–æ)"
echo "   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–∏ API –ø–æ HTTP: curl http://$DOMAIN/api/health"
echo ""
echo "2. –°–æ–∑–¥–∞–π—Ç–µ –ø–æ–¥–¥–æ–º–µ–Ω –¥–ª—è API:"
echo "   - –î–æ–±–∞–≤—å—Ç–µ DNS –∑–∞–ø–∏—Å—å: api.$DOMAIN ‚Üí $SERVER_IP (DNS only)"
echo "   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ https://api.$DOMAIN/api/health"
echo ""
echo "3. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É Cloudflare"
echo ""
echo "üìã –ö–û–ù–¢–†–û–õ–¨–ù–´–ô –°–ü–ò–°–û–ö:"
echo "---------------------"
echo "[ ] DNS –∑–∞–ø–∏—Å—å –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –Ω–∞ $SERVER_IP"
echo "[ ] Proxy status: Proxied (–æ—Ä–∞–Ω–∂–µ–≤–æ–µ –æ–±–ª–∞–∫–æ)"
echo "[ ] SSL —Ä–µ–∂–∏–º: Full (strict)"
echo "[ ] Always Use HTTPS: On"
echo "[ ] –ù–µ—Ç –ø—Ä–∞–≤–∏–ª –±–ª–æ–∫–∏—Ä—É—é—â–∏—Ö /api/*"
echo "[ ] –ü–æ–¥–æ–∂–¥–∞–ª 30 –º–∏–Ω—É—Ç –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π"
echo "[ ] –ü—Ä–æ–≤–µ—Ä–∏–ª: curl https://$DOMAIN/api/health"
echo ""
echo "‚ú® –ò–ù–°–¢–†–£–ö–¶–ò–ò –ó–ê–í–ï–†–®–ï–ù–´!"
echo "–í—ã–ø–æ–ª–Ω–∏—Ç–µ —à–∞–≥–∏ 1-6 –≤ Cloudflare Dashboard, –∑–∞—Ç–µ–º –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç."